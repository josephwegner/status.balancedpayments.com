/// strftime
/// https://github.com/samsonjs/strftime
/// @_sjs
///
/// Copyright 2010 - 2011 Sami Samhuri <sami.samhuri@gmail.com>
/// MIT License
function renderForDate(e,t,n,r,i){var s=e.find("#date-"+n),o=t.index($("#date-"+n)),u=o===0||i==0&&o===-1?"%b %d":"%d",a=n.split("-");n==(new Date(a[0],a[1],0)).strftime("%Y-%m-%d")&&(u="%b %d");var f=$('<div class="date"></div>').text((new Date(a[0],a[1]-1,a[2])).strftime(u)),l=$('<li id="date-'+n+'"></li>'),c=!1,h=!1;f.appendTo(l);for(var p in SERVICES){var d=SERVICES[p],v=r[d],m=[];for(var g=0;g<v.length;g++){var y=v[g];(new Date(y.created_at)).strftime("%Y-%m-%d")===n&&m.push(y)}var b=renderServiceMessages(m,d);b.element.appendTo(l),b.hasMessages&&(c=!0),b.hasErrors&&(h=!0)}c&&l.addClass("messages").addClass("issues");if(!s.length){var w=calculateIndex(n,t);w===t.length?l.appendTo(e):e.find("> li").eq(w).before(l)}else s.replaceWith(l)}function calculateIndex(e,t){var n=[],r=new Date(e);t.each(function(e,t){var r=$(t).attr("id").replace("date-","");n.push(r)}),n.sort();for(var i=0;i<n.length;i++){var s=new Date(n[i]);if(s<r)return i}return t.length}function renderServiceMessages(e,t){var n=$("<div>&nbsp;</div>"),r=!1,i=!1,s=!1,o=!1;for(var u in e){var a=e[u];DISPLAYABLE_STATUSES.indexOf(a.status)>-1&&($(renderMessage(a)).appendTo(n),i=!0,a.status===ERROR_STATE&&(o=!0,r=!0))}var f=$('<div class="'+t+'"></div>');return i&&(f.addClass("issues"),r&&f.addClass("errors"),s=!0),n.appendTo(f),{element:f,hasErrors:o,hasMessages:s}}function renderMessage(e){var t=new Date(e.created_at),n=t.strftime("%b %d @ %I:%M")+t.strftime("%p").toLowerCase();return'<div class="issue" data-state="'+e.status+'">'+"<p>"+linkify(e.message)+"</p>"+'<time datetime="'+t+'">'+n+"</time>"+'<a href="https://twitter.com/balancedstatus/status/'+e.tweet_id+'" class="tweet" target="_blank">@balancedstatus</a>'+"</div>"}function setUpdated(){var e=$(".stc.summary h2 time"),t=new Date;e.attr("datetime",t).text(t.strftime("%b %d, %Y @ %I:%M")+" "+t.strftime("%p").toLowerCase()+" "+t.strftime("%Z"))}function linkify(e){var t=/\b(http|https)+(:\/\/)+(\S*)/ig,n=e.match(t);if(!n)return e;for(var r=0;r<n.length;r++){var i=n[r];e=e.replace(i,'<a href="'+i+'" target="_blank">'+i+"</a>")}return e}function evenColumnHeights(){$(".messages.stc li.messages").each(function(e,t){var n=0;$(t).find(".issues").each(function(e,t){var r=$(t).height();r>n&&(n=r)}),$(t).find(".issues > div").each(function(e,t){var r=$(t),i=r.parent().children().length;r.height(n/i)})})}var strftime=function(){function e(e){return(e||"").split(" ")}function n(e,s,o,u){s&&!(s instanceof Date)&&(o=s,s=undefined),s=s||new Date,o=o||t,o.formats=o.formats||{};var a=0;return u&&(a=(s.getTimezoneOffset()||0)*6e4,s=new Date(s.getTime()+a)),e.replace(/%(.)/g,function(e,t){switch(t){case"A":return o.days[s.getDay()];case"a":return o.shortDays[s.getDay()];case"B":return o.months[s.getMonth()];case"b":case"h":return o.shortMonths[s.getMonth()];case"D":return n(o.formats.D||"%m/%d/%y",s,o);case"d":return r(s.getDate());case"e":return s.getDate();case"F":return n(o.formats.F||"%Y-%m-%d",s,o);case"H":return r(s.getHours());case"I":return r(i(s));case"k":return r(s.getHours()," ");case"L":return r(Math.floor(s.getTime()%1e3),3);case"l":return r(i(s)," ");case"M":return r(s.getMinutes());case"m":return r(s.getMonth()+1);case"n":return"\n";case"p":return s.getHours()<12?o.AM:o.PM;case"R":return n(o.formats.R||"%H:%M",s,o);case"r":return n(o.formats.r||"%I:%M:%S %p",s,o);case"S":return r(s.getSeconds());case"s":return Math.floor((s.getTime()-a)/1e3);case"T":return n(o.formats.T||"%H:%M:%S",s,o);case"t":return"	";case"u":var f=s.getDay();return f===0?7:f;case"v":return n(o.formats.v||"%e-%b-%Y",s,o);case"w":return s.getDay();case"Y":return s.getFullYear();case"y":var l=String(s.getFullYear());return l.slice(l.length-2);case"Z":if(u)return"GMT";var c=s.toString().match(/\((\w+)\)/);return c&&c[1]||"";case"z":if(u)return"+0000";var h=s.getTimezoneOffset();return(h<0?"+":"-")+r(h/60)+r(h%60);default:return t}})}function r(e,t,n){typeof t=="number"&&(n=t,t="0"),t=t||"0",n=n||2;var r=String(e);while(r.length<n)r=t+r;return r}function i(e){var t=e.getHours();return t===0?t=12:t>12&&(t-=12),t}var t={days:e("Sunday Monday Tuesday Wednesday Thursday Friday Saturday"),shortDays:e("Sun Mon Tue Wed Thu Fri Sat"),months:e("January February March April May June July August September October November December"),shortMonths:e("Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec"),AM:"AM",PM:"PM"};return{strftime:function(e,t){return n(e,this,t,!1)},strftimeUTC:function(e,t){return n(e,this,t,!0)},localizedStrftime:function(e){return function(t){return strftime(t,this,e)}}}}();Date.prototype.strftime=strftime.strftime,Date.prototype.strftimeUTC=strftime.strftimeUTC,Date.prototype.localizedStrftime=strftime.localizedStrftime;var timer=null,intervalSeconds=15,interval=1e3*intervalSeconds,SERVICES=["API","JS","DASH"],DISPLAYABLE_STATUSES=["UP","DOWN","ISSUE"],ERROR_STATE="DOWN",loadData=function(){console.log("loading"),loadUptime(),loadMessages(),loadCalendar()},truncateDecimals=function(e,t){t||(t=2);var n=Math.pow(10,t);return Math.floor(e*n)/n},setServiceStatus=function(e,t){$(".services.stc ."+e+" .uptime-image").removeClass("ISSUE").removeClass("DOWN").removeClass("UP").addClass(t)},loadUptime=function(){$.get("/uptime",function(e){console.log("uptime",e);for(var t in e.uptime){var n=e.uptime[t].uptime,r=e.uptime[t].status;n===100?n=n.toFixed(2):n=truncateDecimals(n,3).toFixed(3),$("."+t,".uptime").find("h1").html(n+"<span>%</span>"),setServiceStatus(t,r)}setUpdated()})},loadMessages=function(e){$.get("/twitter/messages/latest",{offset:e},function(e){for(var t in e.messages){var n=e.messages[t],r;n?r=renderMessage(n):r="<em>None</em>",$("."+t,".recent-updates").html(r)}setUpdated()})},loadCalendar=function(e){$.get("/twitter/messages",{offset:e},function(e){var t=new Date(e.messages.min*1e3),n=new Date(e.messages.max*1e3);delete e.messages.max,delete e.messages.min,console.log("tweets",e,t,n);var r=$(".messages.stc ul"),i=r.find("li"),s=[],o;for(var u=n;u>=t;u.setDate(u.getDate()-1))s.push((new Date(u)).strftime("%Y-%m-%d"));s.sort(),s.reverse();for(var a in s){o=s[a];var f=e.messages;renderForDate(r,i,o,f,a)}evenColumnHeights(),setUpdated()})},Balanced={init:function(e){Status.init(e)}},Status={init:function(e){loadData(),timer=setInterval(loadData,interval),$(".load button").click(function(e){loadCalendar($(".messages ul li").length)})}};Balanced.Status=Status;